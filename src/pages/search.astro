---
import Layout from '../layouts/Layout.astro';
import SearchBar from '../components/SearchBar.astro';
---

<Layout title="Search Prompts - AwesomePrompts">
  <div class="max-w-4xl mx-auto">
    <!-- Hero Section matching home page -->
    <section class="mb-8">
      <div class="bg-white dark:bg-gray-800 rounded-xl neu-border neu-shadow p-8 text-center">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          Search Prompts
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mb-6">
          Instantly search through all prompts
        </p>
        
        <div class="flex justify-center">
          <SearchBar placeholder="Search all prompts..." />
        </div>
      </div>
    </section>

    <!-- Results Section -->
    <section id="results-section" class="hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 id="results-count" class="text-lg font-semibold text-gray-900 dark:text-gray-100"></h2>
        <button id="clear-search" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
          Clear
        </button>
      </div>
      
      <div id="results-grid" class="masonry-grid">
        <!-- Results will be inserted here -->
      </div>
      
      <div id="load-more-container" class="flex justify-center mt-8 hidden">
        <button id="load-more" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all neu-border neu-shadow neu-shadow-hover">
          Load More
        </button>
      </div>
    </section>

    <!-- Empty state -->
    <section id="empty-state" class="hidden">
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">No results found. Try a different search term.</p>
      </div>
    </section>

    <!-- Loading state -->
    <section id="loading-state" class="hidden">
      <div class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-purple-600 border-t-transparent"></div>
        <p class="mt-4 text-gray-500 dark:text-gray-400">Searching...</p>
      </div>
    </section>

    <!-- Dev mode message -->
    <section id="dev-message" class="hidden">
      <div class="text-center py-8 text-gray-500 dark:text-gray-400">
        <p>Search is available after building.</p>
        <p class="mt-2">Run: <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">bun run build</code> first, then preview with <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">bun run preview</code></p>
      </div>
    </section>
  </div>
</Layout>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet">

<script is:inline>
  let pagefind = null;
  let currentQuery = '';
  let currentResults = [];
  let displayedCount = 0;
  const RESULTS_PER_PAGE = 9;

  // Initialize pagefind
  async function initPagefind() {
    try {
      pagefind = await import('/pagefind/pagefind.js');
      await pagefind.init();
      
      // Check for query parameter
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('q');
      if (query) {
        document.getElementById('search-input').value = query;
        performSearch(query);
      }
    } catch (e) {
      console.log('Pagefind not available (dev mode)');
      document.getElementById('dev-message').classList.remove('hidden');
    }
  }

  // Perform search
  async function performSearch(query) {
    if (!pagefind || !query.trim()) {
      hideAllSections();
      return;
    }

    currentQuery = query.trim();
    displayedCount = 0;
    
    // Show loading
    hideAllSections();
    document.getElementById('loading-state').classList.remove('hidden');

    try {
      const search = await pagefind.search(currentQuery);
      currentResults = search.results;
      
      hideAllSections();
      
      if (currentResults.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
      } else {
        document.getElementById('results-section').classList.remove('hidden');
        document.getElementById('results-count').textContent = `${currentResults.length} result${currentResults.length !== 1 ? 's' : ''} for "${currentQuery}"`;
        document.getElementById('results-grid').innerHTML = '';
        loadMoreResults();
      }
    } catch (e) {
      console.error('Search error:', e);
      hideAllSections();
      document.getElementById('empty-state').classList.remove('hidden');
    }
  }

  // Load more results
  async function loadMoreResults() {
    const grid = document.getElementById('results-grid');
    const endIndex = Math.min(displayedCount + RESULTS_PER_PAGE, currentResults.length);
    
    for (let i = displayedCount; i < endIndex; i++) {
      const result = currentResults[i];
      const data = await result.data();
      
      const card = createResultCard(data);
      grid.appendChild(card);
    }
    
    displayedCount = endIndex;
    
    // Show/hide load more button
    const loadMoreContainer = document.getElementById('load-more-container');
    if (displayedCount < currentResults.length) {
      loadMoreContainer.classList.remove('hidden');
    } else {
      loadMoreContainer.classList.add('hidden');
    }
  }

  // Category color mapping matching MasonryCard
  const categoryColors = {
    posters: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
    creative: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
    '3d': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
    icons: 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200',
    portraits: 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200',
    motion: 'bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200',
  };

  // Create result card matching MasonryCard style
  function createResultCard(data) {
    const card = document.createElement('a');
    card.href = data.url;
    card.className = 'masonry-card block bg-white dark:bg-gray-800 rounded-xl neu-border neu-shadow overflow-hidden transition-all neu-shadow-hover break-inside-avoid mb-4';
    
    // Extract category from URL
    const urlParts = data.url.split('/').filter(Boolean);
    const category = urlParts.length > 2 ? urlParts[1] : 'general';
    
    // Get category color
    const colorClass = categoryColors[category] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
    
    // Check if there's a preview image or video in the meta
    const preview = data.meta?.image || data.image;
    const previewVideo = data.meta?.video;
    const hasVideo = category === 'motion' && previewVideo;
    
    // Extract tags from meta if available
    const tags = data.meta?.tags ? data.meta.tags.split(',').map(t => t.trim()) : [];
    
    // Build preview HTML
    let previewHtml = '';
    if (hasVideo) {
      previewHtml = `
        <div class="w-full overflow-hidden aspect-video relative">
          <video 
            src="${previewVideo}"
            class="w-full h-full object-cover"
            autoplay
            loop
            muted
            playsinline
          ></video>
          <div class="absolute top-2 right-2 bg-rose-500 text-white text-xs px-2 py-0.5 rounded-full font-medium flex items-center gap-1">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><polygon points="5,3 19,10 5,17"/></svg>
            Motion
          </div>
        </div>
      `;
    } else if (preview) {
      previewHtml = `
        <div class="w-full overflow-hidden">
          <img 
            src="${preview}" 
            alt="${data.meta?.title || 'Preview'}" 
            class="w-full h-auto"
            loading="lazy"
          />
        </div>
      `;
    }
    
    card.innerHTML = `
      ${previewHtml}
      <div class="p-4">
        <div class="flex items-start justify-between mb-2">
          <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium ${colorClass}">
            ${category}
          </span>
        </div>
        <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-1 line-clamp-2">
          ${data.meta?.title || 'Untitled'}
        </h3>
        <div class="flex flex-wrap gap-1 mt-2">
          ${tags.slice(0, 2).map(tag => `<span class="text-xs text-gray-500 dark:text-gray-400">#${tag}</span>`).join('')}
        </div>
      </div>
    `;
    
    return card;
  }

  // Strip highlight tags from excerpt
  function stripHighlight(text) {
    return text.replace(/<mark>/g, '<span class="bg-yellow-200 dark:bg-yellow-800 px-0.5 rounded">').replace(/<\/mark>/g, '</span>');
  }

  // Hide all sections
  function hideAllSections() {
    document.getElementById('results-section').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('dev-message').classList.add('hidden');
  }

  // Clear search
  function clearSearch() {
    document.getElementById('search-input').value = '';
    currentQuery = '';
    currentResults = [];
    displayedCount = 0;
    hideAllSections();
    
    // Update URL
    const url = new URL(window.location);
    url.searchParams.delete('q');
    window.history.replaceState({}, '', url);
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    initPagefind();
    
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const clearButton = document.getElementById('clear-search');
    const loadMoreButton = document.getElementById('load-more');
    
    // Search on enter or button click
    searchInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = searchInput.value.trim();
        if (query) {
          // Update URL
          const url = new URL(window.location);
          url.searchParams.set('q', query);
          window.history.replaceState({}, '', url);
          performSearch(query);
        }
      }
    });
    
    searchButton?.addEventListener('click', () => {
      const query = searchInput?.value?.trim();
      if (query) {
        const url = new URL(window.location);
        url.searchParams.set('q', query);
        window.history.replaceState({}, '', url);
        performSearch(query);
      }
    });
    
    clearButton?.addEventListener('click', clearSearch);
    loadMoreButton?.addEventListener('click', loadMoreResults);
  });
</script>

<style>
  .masonry-grid {
    columns: 1;
    column-gap: 1rem;
  }
  
  @media (min-width: 640px) {
    .masonry-grid {
      columns: 2;
    }
  }
  
  @media (min-width: 1024px) {
    .masonry-grid {
      columns: 3;
    }
  }
  
  @media (min-width: 1280px) {
    .masonry-grid {
      columns: 4;
    }
  }
  
  .masonry-card:hover img {
    transform: scale(1.02);
    transition: transform 0.3s ease;
  }
  
  .masonry-card img {
    transition: transform 0.3s ease;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

